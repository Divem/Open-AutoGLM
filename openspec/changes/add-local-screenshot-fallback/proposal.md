# 提案：添加本地截图文件备用方案

## Why
用户报告执行截图数据为空，经过分析发现：
1. 数据库中的任务步骤数据缺少`screenshot_path`和`screenshot_url`字段
2. 本地文件系统有269个截图文件存储在`/web/static/screenshots/`目录中
3. 当前系统只从数据库提取截图数据，没有利用本地文件资源
4. 需要实现当远程数据库无数据时，使用本地文件路径作为备用方案

## What Changes
1. **添加本地文件扫描功能**：扫描本地screenshots目录并与任务ID关联
2. **实现智能文件匹配算法**：根据文件名时间戳匹配任务创建时间
3. **增强数据提取逻辑**：在`get_step_report_data`函数中添加本地文件回退机制
4. **添加文件路径转换**：将本地相对路径转换为可访问的URL路径
5. **实现数据完整性验证**：确保文件真实存在且可访问

## 问题描述

### 问题现象
- 任务报告页面的执行截图显示"暂无执行截图"
- 数据库查询显示步骤数据中`screenshot_path`和`screenshot_url`为空
- 本地文件系统存在大量截图文件但未被利用

### 根本原因分析
1. **数据断层**：截图文件已生成为本地文件，但没有存储到数据库
2. **数据源单一**：系统只从数据库提取截图数据，忽略了本地文件资源
3. **文件关联缺失**：本地截图文件没有与对应任务建立关联关系
4. **回退机制缺失**：没有当数据库无数据时的备用数据获取方案

### 数据现状
- 本地截图文件：269个PNG文件在`/web/static/screenshots/`
- 数据库截图数据：step_screenshots表为空，task_steps表无截图路径
- 文件命名格式：`screenshot_YYYYMMDD_HHMMSS_xxx_hash.png`

## 解决方案

### 核心策略
实现三级数据提取策略：
1. **主数据源**：从数据库step_screenshots表获取
2. **次数据源**：从task_steps表的screenshot_path/screenshot_url字段获取
3. **备用数据源**：扫描本地screenshots目录，按时间匹配任务

### 技术方案
1. **本地文件扫描器**：
   - 扫描`/web/static/screenshots/`目录
   - 解析文件名中的时间戳信息
   - 根据任务创建时间范围匹配相关截图

2. **智能匹配算法**：
   - 基于文件创建时间和任务执行时间的时间窗口匹配
   - 支持模糊时间匹配（如前后5分钟内的截图）
   - 按文件修改时间排序，优先显示最新截图

3. **路径转换机制**：
   - 将本地绝对路径转换为Web可访问的相对路径
   - 确保文件存在性验证
   - 提供文件大小和创建时间等元数据

4. **数据聚合逻辑**：
   - 合并数据库和本地文件数据
   - 去重处理（同一文件的不同来源）
   - 按时间顺序排列截图

## 实施计划

### Phase 1: 本地文件扫描器（30分钟）
- [ ] 创建本地文件扫描函数
- [ ] 实现文件名时间戳解析
- [ ] 添加文件存在性验证
- [ ] 实现基础文件匹配逻辑

### Phase 2: 智能匹配算法（30分钟）
- [ ] 实现时间窗口匹配算法
- [ ] 添加任务时间范围计算
- [ ] 实现文件排序和优先级逻辑
- [ ] 添加匹配度评分机制

### Phase 3: 数据集成（20分钟）
- [ ] 修改get_step_report_data函数
- [ ] 集成本地文件扫描逻辑
- [ ] 实现数据合并和去重
- [ ] 添加路径转换和URL生成

### Phase 4: 测试验证（20分钟）
- [ ] 测试空数据库情况下的本地文件回退
- [ ] 测试混合数据源的截图显示
- [ ] 验证文件路径可访问性
- [ ] 测试性能影响

## 验收标准

**功能正确性**：
- ✅ 当数据库无截图数据时，能从本地文件系统获取相关截图
- ✅ 本地截图能正确显示在任务报告页面
- ✅ 截图按时间顺序合理排列
- ✅ 文件路径能正确转换为可访问的URL

**数据完整性**：
- ✅ 匹配算法能准确找到任务相关的截图
- ✅ 重复文件能正确去重
- ✅ 文件元数据（大小、时间）正确显示
- ✅ 不存在的文件被正确过滤

**性能影响**：
- ✅ 本地文件扫描不影响页面加载性能（<2秒）
- ✅ 算法复杂度合理，支持大量文件
- ✅ 缓存机制减少重复扫描开销

**错误处理**：
- ✅ 本地文件访问失败时有友好提示
- ✅ 时间匹配异常时不会崩溃
- ✅ 文件损坏或格式不支持时能正确跳过

## 风险评估

**低风险**：
- 只添加备用数据源，不影响现有数据库逻辑
- 本地文件读取操作安全可控
- 有完整的错误处理和验证机制

**缓解措施**：
- 实现渐进式加载，避免大量文件扫描阻塞
- 添加文件数量限制，防止性能问题
- 提供配置开关，可以禁用本地文件功能

## 优先级
**高优先级** - 能快速解决截图显示问题，提升用户体验

## 时间估算
- **总实现时间**：1小时40分钟
- **核心功能**：50分钟
- **测试验证**：20分钟
- **优化调整**：30分钟

## 成功指标
修复后，用户应该能够：
1. 在任务报告页面看到执行截图（即使数据库为空）
2. 截图按时间顺序合理排列
3. 本地文件和数据库数据无缝整合显示
4. 获得更好的任务执行可视化体验