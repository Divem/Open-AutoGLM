## 添加本地截图文件备用方案任务清单

### Phase 1: 本地文件扫描器实现（30分钟）
- [x] 1.1 创建LocalFileScanner类和相关数据结构
- [x] 1.2 实现文件名时间戳解析逻辑（screenshot_YYYYMMDD_HHMMSS_xxx_hash.png）
- [x] 1.3 添加文件存在性验证和元数据提取
- [x] 1.4 实现本地文件目录扫描功能
- [x] 1.5 添加文件扫描结果缓存机制

### Phase 2: 智能匹配算法（30分钟）
- [x] 2.1 创建ScreenshotMatcher类
- [x] 2.2 实现任务时间范围计算和时间窗口匹配
- [x] 2.3 添加匹配度评分算法
- [x] 2.4 实现文件按时间排序和优先级逻辑
- [x] 2.5 添加匹配结果数量限制

### Phase 3: 路径转换和数据集成（20分钟）
- [x] 3.1 创建PathConverter类处理路径转换
- [x] 3.2 实现本地路径到Web URL的转换逻辑
- [x] 3.3 创建DataAggregator类聚合多源数据
- [x] 3.4 实现数据去重和优先级排序
- [x] 3.5 集成到get_step_report_data函数中

### Phase 4: 性能优化和缓存（15分钟）
- [x] 4.1 实现LRU缓存减少重复文件扫描
- [x] 4.2 添加异步处理避免阻塞主流程
- [x] 4.3 实现分页支持处理大量文件
- [x] 4.4 优化文件扫描性能
- [x] 4.5 添加配置参数和功能开关

### Phase 5: 错误处理和日志记录（10分钟）
- [x] 5.1 添加文件系统访问错误处理
- [x] 5.2 实现文件解析错误的优雅处理
- [x] 5.3 添加详细的操作日志记录
- [x] 5.4 实现调试信息和性能监控
- [x] 5.5 添加错误统计和质量指标

### Phase 6: 测试验证（25分钟）
- [x] 6.1 测试数据库为空时的本地文件回退
- [x] 6.2 测试不同时间窗口的文件匹配准确性
- [x] 6.3 测试多源数据聚合和去重功能
- [x] 6.4 测试性能影响和响应时间
- [x] 6.5 验证前端截图显示和用户交互

### Phase 7: 配置管理和API集成（15分钟）
- [x] 7.1 实现环境变量配置系统
- [x] 7.2 添加动态配置更新功能
- [x] 7.3 创建配置管理API端点
- [x] 7.4 实现性能监控和统计API
- [x] 7.5 添加功能测试和诊断API

## 验收标准

修复完成后，以下标准必须全部满足：

**核心功能实现**:
- [ ] 当数据库无截图数据时，能从本地文件获取相关截图
- [ ] 本地截图能正确解析时间戳并匹配到对应任务
- [ ] 截图文件能转换为Web可访问的URL路径
- [ ] 多源数据能正确聚合和去重
- [ ] 本地文件回退对前端完全透明

**数据完整性保障**:
- [ ] 匹配算法能准确找到任务时间范围内的截图
- [ ] 文件元数据（大小、创建时间）正确提取和显示
- [ ] 重复文件能正确识别并去重
- [ ] 不存在或损坏的文件能被过滤
- [ ] 数据源信息在响应中正确标注

**性能影响控制**:
- [ ] 本地文件扫描不显著增加API响应时间（<2秒）
- [ ] 大量文件时内存使用合理（<100MB）
- [ ] 缓存机制有效减少重复扫描开销
- [ ] 支持大量截图文件的场景（>1000个文件）
- [ ] 分页和限制机制有效防止性能问题

**错误处理完善**:
- [ ] 文件系统权限错误能优雅处理
- [ ] 文件名解析错误不影响其他文件处理
- [ ] 网络路径转换失败时有适当降级
- [ ] 错误信息详细记录便于调试
- [ ] 系统稳定性不受本地文件问题影响

**用户体验提升**:
- [ ] 任务报告页面不再显示"暂无执行截图"
- [ ] 截图按时间顺序合理排列显示
- [ ] 截图加载速度和响应性良好
- [ ] 支持大量截图的流畅浏览
- [ ] 用户能获得完整的任务执行可视化

## 技术实现细节

### 文件扫描器实现要点
```python
class LocalFileScanner:
    def __init__(self, screenshots_dir: str = "static/screenshots"):
        self.screenshots_dir = screenshots_dir
        self.cache_timeout = 300  # 5分钟缓存

    def scan_screenshots(self) -> List[FileInfo]:
        # 实现文件扫描和时间戳解析
        # 支持文件名格式: screenshot_YYYYMMDD_HHMMSS_xxx_hash.png
        # 返回按时间排序的文件信息列表
```

### 匹配算法核心逻辑
```python
def match_screenshots_to_task(self, task_info: dict, files: List[FileInfo]) -> List[FileInfo]:
    # 基于任务创建时间和执行时间窗口匹配
    # 支持前后N分钟的时间容差
    # 按匹配度评分排序，优先显示最相关截图
```

### 路径转换规则
```python
def convert_to_web_url(self, local_path: str) -> str:
    # /Users/.../web/static/screenshots/screenshot.png
    # → /static/screenshots/screenshot.png
    # 确保路径在Web应用中可访问
```

## 配置参数

### 可配置选项
- **time_window_minutes**: 匹配时间窗口（默认10分钟）
- **max_screenshots**: 最大返回截图数量（默认50张）
- **enable_fallback**: 是否启用本地文件回退（默认true）
- **cache_timeout**: 扫描结果缓存时间（默认300秒）
- **screenshots_directory**: 截图文件目录路径

### 环境变量支持
```bash
SCREENSHOT_FALLBACK_ENABLED=true
SCREENSHOT_TIME_WINDOW=10
SCREENSHOT_MAX_FILES=50
SCREENSHOT_CACHE_TIMEOUT=300
```

## 监控指标

### 性能指标
- 文件扫描平均耗时
- 缓存命中率
- API响应时间影响
- 内存使用峰值

### 业务指标
- 本地文件回退成功率
- 截图匹配准确率
- 用户报告完整性提升
- 错误发生频率

## 风险控制

**低风险操作**:
- [ ] 只添加数据获取功能，不修改现有数据结构
- [ ] 保持向后兼容，不影响现有API行为
- [ ] 实现渐进式集成，可随时回滚
- [ ] 添加完整日志记录便于问题诊断

**质量保证**:
- [ ] 单元测试覆盖所有核心功能
- [ ] 集成测试验证完整工作流程
- [ ] 性能测试确保不影响响应时间
- [ ] 错误场景测试保证系统稳定性

## 部署策略

**灰度部署**:
1. 先在测试环境验证所有功能
2. 生产环境部署时可通过配置禁用回退功能
3. 监控部署后的性能和错误指标
4. 逐步启用回退功能并验证效果

**回滚准备**:
- [ ] 保留原始代码作为备份
- [ ] 实现配置开关可快速禁用新功能
- [ ] 监控关键指标，异常时自动回滚
- [ ] 准备详细回滚操作步骤

## 成功指标

修复后，系统应该达到以下指标：

**功能指标**:
- 截图数据获取成功率: >95%（从当前0%提升）
- 本地文件回退触发成功率: >90%
- 用户报告完整性: 显著提升
- API响应成功率: >99.9%

**性能指标**:
- API响应时间增加: <500ms
- 文件扫描缓存命中率: >80%
- 内存使用增加: <50MB
- 并发处理能力: 无显著影响

**用户体验指标**:
- "暂无执行截图"显示率: <5%
- 用户满意度: >4.0/5
- 任务可视化完整性: 显著改善
- 错误报告减少: >80%