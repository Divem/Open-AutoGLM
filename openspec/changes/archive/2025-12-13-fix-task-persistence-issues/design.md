# Design: ä»»åŠ¡æŒä¹…åŒ–é—®é¢˜ä¿®å¤

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
å½“å‰ç³»ç»Ÿåœ¨ä»SupabaseåŠ è½½ä»»åŠ¡æ—¶å¤±è´¥çš„æ ¹æœ¬åŸå› æ˜¯**æ•°æ®åº“Schemaä¸Python dataclasså®šä¹‰ä¸ä¸€è‡´**:

1. **æ•°æ®åº“è¿”å›é¢å¤–å­—æ®µ**: Supabaseçš„SELECTæŸ¥è¯¢è¿”å›æ‰€æœ‰å­—æ®µ,åŒ…æ‹¬æ•°æ®åº“å†…éƒ¨ç»´æŠ¤çš„`id` (UUIDä¸»é”®)å’Œ`updated_at`å­—æ®µ
2. **Dataclassä¸¥æ ¼å‚æ•°åŒ¹é…**: Pythonçš„dataclassåœ¨åˆå§‹åŒ–æ—¶ä¸æ¥å—æœªå®šä¹‰çš„å‚æ•°,ä¼šæŠ›å‡ºTypeError
3. **ç¼ºå°‘å­—æ®µè¿‡æ»¤æœºåˆ¶**: `GlobalTask.from_dict()`ç›´æ¥å°†å­—å…¸å±•å¼€ä¼ ç»™`__init__()`,æ²¡æœ‰è¿‡æ»¤é€»è¾‘

### å½±å“èŒƒå›´
- åº”ç”¨å¯åŠ¨å¤±è´¥,Webç•Œé¢æ— æ³•è®¿é—®
- æ‰€æœ‰å†å²ä»»åŠ¡æ•°æ®æ— æ³•åŠ è½½
- æ–°ä»»åŠ¡å¯ä»¥åˆ›å»ºä½†é‡å¯åä¸¢å¤±(å› ä¸ºåŠ è½½å¤±è´¥)

---

## è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ1: å­—æ®µç™½åå•è¿‡æ»¤ (æ¨è)

**æ ¸å¿ƒæ€è·¯**: åœ¨`from_dict()`ä¸­ä½¿ç”¨dataclassçš„å­—æ®µå®šä¹‰ä½œä¸ºç™½åå•,è¿‡æ»¤é¢å¤–å­—æ®µã€‚

**ä¼˜ç‚¹**:
- è‡ªåŠ¨é€‚åº”dataclasså®šä¹‰çš„å˜åŒ–
- ä¸éœ€è¦æ‰‹åŠ¨ç»´æŠ¤å­—æ®µåˆ—è¡¨
- ç®€æ´ä¸”æ˜“äºç†è§£

**å®ç°**:
```python
import dataclasses
from typing import Dict

@classmethod
def from_dict(cls, data: Dict) -> 'GlobalTask':
    # è·å–æ‰€æœ‰dataclasså­—æ®µå
    valid_fields = {f.name for f in dataclasses.fields(cls)}

    # è¿‡æ»¤å­—å…¸,åªä¿ç•™æœ‰æ•ˆå­—æ®µ
    filtered_data = {k: v for k, v in data.items() if k in valid_fields}

    # ç±»å‹è½¬æ¢(datetimeç­‰)
    filtered_data = cls._convert_types(filtered_data)

    return cls(**filtered_data)
```

### æ–¹æ¡ˆ2: æ•°æ®åº“æŸ¥è¯¢æ—¶æ’é™¤å­—æ®µ (ä¸æ¨è)

**æ ¸å¿ƒæ€è·¯**: åœ¨SupabaseæŸ¥è¯¢æ—¶æ˜ç¡®åˆ—å‡ºéœ€è¦çš„å­—æ®µã€‚

**ç¼ºç‚¹**:
- éœ€è¦æ‰‹åŠ¨ç»´æŠ¤å­—æ®µåˆ—è¡¨
- æ–°å¢å­—æ®µæ—¶å®¹æ˜“é—æ¼
- æŸ¥è¯¢è¯­å¥å†—é•¿

---

## æ•°æ®éªŒè¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Supabase Database              â”‚
â”‚  è¿”å›: {id, task_id, ..., updated_at}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      SupabaseTaskManager                â”‚
â”‚      .load_tasks()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ for task_data in results:
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ•°æ®éªŒè¯å±‚      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚
         â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¿«é€ŸéªŒè¯ â”‚      â”‚ è¯¦ç»†éªŒè¯ â”‚
   â”‚ (å¿…éœ€)   â”‚      â”‚ (å¯é€‰)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚
        â”‚  Valid         â”‚  Invalid
        â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è½¬æ¢   â”‚      â”‚ è®°å½•é”™è¯¯  â”‚
   â”‚        â”‚      â”‚ è·³è¿‡ä»»åŠ¡  â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GlobalTask       â”‚
â”‚ .from_dict()     â”‚
â”‚ - å­—æ®µè¿‡æ»¤       â”‚
â”‚ - ç±»å‹è½¬æ¢       â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task Object      â”‚
â”‚ æ·»åŠ åˆ°å†…å­˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éªŒè¯å±‚æ¬¡

**Level 1: å¿«é€ŸéªŒè¯** (å¿…éœ€,æ¯ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œ)
- æ£€æŸ¥å¿…éœ€å­—æ®µå­˜åœ¨
- éªŒè¯å­—æ®µç±»å‹
- è€—æ—¶: <1ms/ä»»åŠ¡

**Level 2: è¯¦ç»†éªŒè¯** (å¯é€‰,ä»…åœ¨å‡ºé”™æ—¶æ‰§è¡Œ)
- éªŒè¯æšä¸¾å€¼åˆæ³•æ€§
- æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
- å°è¯•ä¿®å¤å¯æ¢å¤çš„é—®é¢˜
- è€—æ—¶: ~5ms/ä»»åŠ¡

---

## é”™è¯¯å¤„ç†ç­–ç•¥

### åˆ†çº§å¤„ç†

| é”™è¯¯ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·å½±å“ |
|---------|---------|---------|---------|
| æ•°æ®åº“è¿æ¥å¤±è´¥ | ğŸ”´ Critical | é™çº§åˆ°ç¦»çº¿æ¨¡å¼,åº”ç”¨ç»§ç»­è¿è¡Œ | æ— æ³•æŸ¥çœ‹å†å²,å¯åˆ›å»ºæ–°ä»»åŠ¡ |
| å•ä¸ªä»»åŠ¡æ•°æ®æŸå | ğŸŸ¡ Warning | è·³è¿‡è¯¥ä»»åŠ¡,è®°å½•è­¦å‘Š | è¯¥ä»»åŠ¡ä¸å¯è§,å…¶ä»–æ­£å¸¸ |
| å­—æ®µç±»å‹é”™è¯¯ | ğŸŸ¡ Warning | å°è¯•è½¬æ¢,å¤±è´¥åˆ™è·³è¿‡ | è¯¥ä»»åŠ¡ä¸å¯è§,å…¶ä»–æ­£å¸¸ |
| å­—æ®µå€¼éæ³• | ğŸŸ¢ Info | ä½¿ç”¨é»˜è®¤å€¼æˆ–ä¿®å¤ | å®Œå…¨é€æ˜ |

### æ—¥å¿—çº§åˆ«

```python
# CRITICAL: ç³»ç»Ÿçº§é”™è¯¯,å½±å“æ ¸å¿ƒåŠŸèƒ½
logger.critical("æ— æ³•è¿æ¥åˆ°æ•°æ®åº“,åº”ç”¨ä»¥ç¦»çº¿æ¨¡å¼è¿è¡Œ")

# ERROR: åŠŸèƒ½æ€§é”™è¯¯,ç”¨æˆ·å¯æ„ŸçŸ¥
logger.error(f"ä»»åŠ¡{task_id}åŠ è½½å¤±è´¥: {error}")

# WARNING: å¼‚å¸¸æƒ…å†µ,ä½†å·²å¤„ç†
logger.warning(f"è·³è¿‡ä»»åŠ¡{task_id}: å­—æ®µ{field}ç±»å‹ä¸åŒ¹é…")

# INFO: æ­£å¸¸æ“ä½œçš„é‡è¦ä¿¡æ¯
logger.info(f"æˆåŠŸåŠ è½½{count}ä¸ªä»»åŠ¡,è·³è¿‡{skip_count}ä¸ª")

# DEBUG: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
logger.debug(f"è¿‡æ»¤å­—æ®µ: {extra_fields}")
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡åŠ è½½ä¼˜åŒ–

```python
def load_tasks(self) -> bool:
    start_time = time.time()

    # 1. ä¸€æ¬¡æ€§ä»æ•°æ®åº“è·å–æ‰€æœ‰ä»»åŠ¡
    result = self.supabase.table('tasks')\
        .select('*')\
        .order('created_at', desc=True)\
        .execute()

    db_time = time.time() - start_time

    # 2. å¹¶è¡Œå¤„ç†ä»»åŠ¡æ•°æ®(å¯é€‰,å¤§æ•°æ®é‡æ—¶)
    tasks = []
    errors = []

    process_start = time.time()

    for task_data in result.data:
        try:
            task = self._load_single_task(task_data)
            tasks.append(task)
        except Exception as e:
            errors.append((task_data.get('task_id', 'unknown'), str(e)))

    process_time = time.time() - process_start

    # 3. è¾“å‡ºæ€§èƒ½æŠ¥å‘Š
    total_time = time.time() - start_time
    logger.info(f"åŠ è½½{len(tasks)}ä¸ªä»»åŠ¡,è€—æ—¶{total_time:.2f}ç§’ "
                f"(DB:{db_time:.2f}s, å¤„ç†:{process_time:.2f}s)")

    if total_time > 3.0:
        logger.warning(f"ä»»åŠ¡åŠ è½½è€—æ—¶è¿‡é•¿: {total_time:.2f}ç§’")

    return True
```

### å†…å­˜ä¼˜åŒ–

- ä¸åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´çš„dataclass,ä½¿ç”¨è½»é‡çº§ç»“æ„
- å®šæœŸæ¸…ç†å·²å®Œæˆçš„æ—§ä»»åŠ¡(30å¤©å‰)
- å¤§é‡ä»»åŠ¡æ—¶è€ƒè™‘åˆ†é¡µåŠ è½½

---

## é™çº§ç­–ç•¥

### Supabaseä¸å¯ç”¨æ—¶çš„Fallback

```python
class TaskStorageManager:
    def __init__(self):
        self.primary = self._init_supabase()
        self.fallback = LocalTaskStorage()  # pickleæ–‡ä»¶
        self.mode = 'supabase' if self.primary else 'local'

    def add_task(self, task):
        if self.mode == 'supabase':
            try:
                return self.primary.add_task(task)
            except Exception as e:
                logger.warning("Supabaseå†™å…¥å¤±è´¥,åˆ‡æ¢åˆ°æœ¬åœ°å­˜å‚¨")
                self.mode = 'local'

        return self.fallback.add_task(task)
```

**ä¼˜ç‚¹**:
- å®Œå…¨ç¦»çº¿ä¹Ÿèƒ½å·¥ä½œ
- æ•°æ®ä¸ä¸¢å¤±

**ç¼ºç‚¹**:
- å¢åŠ å¤æ‚åº¦
- éœ€è¦å¤„ç†æ•°æ®åŒæ­¥

**å»ºè®®**: ä½œä¸ºå¯é€‰åŠŸèƒ½(é˜¶æ®µ3å®ç°)

---

## æ•°æ®åº“Schemaæ”¹è¿›å»ºè®®

### å½“å‰Schema

```sql
CREATE TABLE tasks (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    task_id TEXT NOT NULL UNIQUE,
    session_id TEXT NOT NULL,
    -- ... å…¶ä»–å­—æ®µ
);
```

### æ”¹è¿›Schema

```sql
CREATE TABLE tasks (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    task_id TEXT NOT NULL UNIQUE,
    session_id TEXT NOT NULL,
    -- ... å…¶ä»–å­—æ®µ

    -- æ–°å¢å­—æ®µ
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- çº¦æŸ
    CONSTRAINT check_status CHECK (status IN ('running', 'completed', 'error', 'stopped'))
);

-- è‡ªåŠ¨æ›´æ–°updated_atçš„è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_tasks_updated_at
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## è¿ç§»è®¡åˆ’

### æ­¥éª¤1: ä»£ç ä¿®å¤ (æ— éœ€æ•°æ®åº“å˜æ›´)
1. ä¿®æ”¹`GlobalTask.from_dict()`æ·»åŠ å­—æ®µè¿‡æ»¤
2. æ·»åŠ æ•°æ®éªŒè¯é€»è¾‘
3. å¢å¼ºé”™è¯¯å¤„ç†
4. éƒ¨ç½²

### æ­¥éª¤2: Schemaä¼˜åŒ– (å¯é€‰)
1. å¤‡ä»½æ•°æ®åº“
2. æ‰§è¡ŒSchemaè¿ç§»è„šæœ¬
3. éªŒè¯æ•°æ®å®Œæ•´æ€§
4. æ›´æ–°ä»£ç ä½¿ç”¨æ–°å­—æ®µ

### æ­¥éª¤3: é™çº§æœºåˆ¶ (å¯é€‰)
1. å®ç°æœ¬åœ°å­˜å‚¨
2. æ·»åŠ è‡ªåŠ¨åŒæ­¥
3. é…ç½®åˆ‡æ¢é€»è¾‘

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```python
def test_from_dict_filters_extra_fields():
    data = {
        'id': 'uuid-123',  # æ•°æ®åº“å­—æ®µ,åº”è¢«è¿‡æ»¤
        'task_id': 'task_123',
        'session_id': 'session_456',
        # ... å…¶ä»–å¿…éœ€å­—æ®µ
        'updated_at': '2025-12-13T10:00:00Z'  # åº”è¢«è¿‡æ»¤
    }

    task = GlobalTask.from_dict(data)

    assert task.task_id == 'task_123'
    assert not hasattr(task, 'id')  # ä¸åº”è¯¥æœ‰idå±æ€§
```

### é›†æˆæµ‹è¯•
```python
def test_load_tasks_with_corrupted_data(supabase_manager):
    # åœ¨æ•°æ®åº“ä¸­æ’å…¥ä¸€äº›æŸåçš„æ•°æ®
    # ...

    success = supabase_manager.load_tasks()

    assert success is True
    # éªŒè¯è·³è¿‡äº†æŸåçš„ä»»åŠ¡ä½†åŠ è½½äº†æœ‰æ•ˆä»»åŠ¡
```

### æ€§èƒ½æµ‹è¯•
```python
def test_load_large_number_of_tasks():
    # åˆ›å»º1000ä¸ªä»»åŠ¡
    # ...

    start = time.time()
    manager.load_tasks()
    duration = time.time() - start

    assert duration < 3.0  # å¿…é¡»åœ¨3ç§’å†…å®Œæˆ
```

---

## é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-----|------|---------|
| æ•°æ®è¿ç§»å¤±è´¥ | ä½ | é«˜ | å®Œæ•´å¤‡ä»½,æä¾›å›æ»šè„šæœ¬ |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ä¸­ | æ€§èƒ½æµ‹è¯•,ä¼˜åŒ–éªŒè¯é€»è¾‘ |
| å‘åå…¼å®¹é—®é¢˜ | ä½ | ä¸­ | ä¿ç•™legacyå±æ€§,æ¸è¿›è¿ç§» |
| Supabaseé™åˆ¶ | ä½ | ä½ | å®ç°fallbackæœºåˆ¶ |

---

## æ€»ç»“

æœ¬è®¾è®¡é‡‡ç”¨**å­—æ®µç™½åå•è¿‡æ»¤**æ–¹æ¡ˆä½œä¸ºæ ¸å¿ƒä¿®å¤,é…åˆ**åˆ†çº§é”™è¯¯å¤„ç†**å’Œ**è¯¦ç»†æ—¥å¿—è®°å½•**,èƒ½å¤Ÿ:

1. âœ… ç«‹å³è§£å†³å½“å‰çš„å¯åŠ¨å¤±è´¥é—®é¢˜
2. âœ… æå‡ç³»ç»Ÿçš„å¥å£®æ€§å’Œå®¹é”™èƒ½åŠ›
3. âœ… ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æ‰“ä¸‹åŸºç¡€
4. âœ… ä¿æŒå‘åå…¼å®¹æ€§

å®æ–½è·¯å¾„æ¸…æ™°,é£é™©å¯æ§,é¢„è®¡3-4å°æ—¶å³å¯å®Œæˆæ ¸å¿ƒä¿®å¤å¹¶é€šè¿‡æµ‹è¯•ã€‚
