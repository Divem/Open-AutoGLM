# Proposal: ä¿®å¤ä»»åŠ¡çŠ¶æ€æ›´æ–°åˆ°æ•°æ®åº“

## æ¦‚è¿°

å½“å‰æ‰€æœ‰å†å²ä»»åŠ¡çš„çŠ¶æ€éƒ½æ˜¾ç¤ºä¸º"running",ä½†å®é™…ä¸Šå¾ˆå¤šä»»åŠ¡å·²ç»å®Œæˆæˆ–å‡ºé”™ã€‚æ ¹æœ¬åŸå› æ˜¯ä»»åŠ¡çŠ¶æ€æ›´æ–°æ²¡æœ‰æ­£ç¡®å†™å…¥Supabaseæ•°æ®åº“ã€‚

## é—®é¢˜æè¿°

### å½“å‰è¡Œä¸º
- æ‰€æœ‰æ•°æ®åº“ä¸­çš„ä»»åŠ¡çŠ¶æ€éƒ½æ˜¯"running"
- ä»»åŠ¡å®Œæˆæˆ–å‡ºé”™å,å‰ç«¯å¯ä»¥çœ‹åˆ°å®æ—¶çŠ¶æ€å˜åŒ–
- ä½†åˆ·æ–°é¡µé¢å,ä»»åŠ¡çŠ¶æ€åˆå˜å›"running"
- å†å²ä»»åŠ¡åˆ—è¡¨æ— æ³•æ­£ç¡®æ˜¾ç¤ºå·²å®Œæˆ/å¤±è´¥çš„ä»»åŠ¡

### æ ¹æœ¬åŸå› 

åœ¨ `web/supabase_manager.py:297` è¡Œ,æ•°æ®åº“æ›´æ–°æŸ¥è¯¢ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå:

```python
result = self.supabase.table('tasks').update(update_data).eq('global_task_id', global_task_id).execute()
```

**é—®é¢˜**: æ•°æ®åº“è¡¨ä¸­çš„ä¸»é”®å­—æ®µåæ˜¯ `task_id`,è€Œä¸æ˜¯ `global_task_id`ã€‚å¯¼è‡´:
1. WHEREæ¡ä»¶æ°¸è¿œåŒ¹é…ä¸åˆ°è®°å½•
2. æ•°æ®åº“æ›´æ–°é™é»˜å¤±è´¥
3. åªæœ‰å†…å­˜ä¸­çš„çŠ¶æ€è¢«æ›´æ–°,æ•°æ®åº“ä¿æŒä¸å˜

### å½±å“
- ç”¨æˆ·æ— æ³•æŸ¥çœ‹ä»»åŠ¡å†å²å’ŒçŠ¶æ€
- æ— æ³•åŒºåˆ†å“ªäº›ä»»åŠ¡å·²å®Œæˆã€å“ªäº›å¤±è´¥
- æ•°æ®ä¸€è‡´æ€§é—®é¢˜:å†…å­˜çŠ¶æ€ â‰  æ•°æ®åº“çŠ¶æ€
- åº”ç”¨é‡å¯åä¸¢å¤±æ‰€æœ‰çŠ¶æ€æ›´æ–°

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®å¤æ•°æ®åº“æŸ¥è¯¢å­—æ®µå (æ¨è)

**æ ¸å¿ƒæ€è·¯**: å°†`eq('global_task_id', ...)`æ”¹ä¸º`eq('task_id', ...)`

**ä¼˜ç‚¹**:
- ä¿®å¤ç®€å•,åªéœ€æ”¹ä¸€è¡Œä»£ç 
- ç«‹å³ç”Ÿæ•ˆ
- æ— éœ€æ•°æ®è¿ç§»
- å‘åå…¼å®¹

**ç¼ºç‚¹**:
- æ— 

### æ–¹æ¡ˆ2: ä¿®æ”¹æ•°æ®åº“Schemaæ·»åŠ global_task_idåˆ—

**æ ¸å¿ƒæ€è·¯**: åœ¨æ•°æ®åº“ä¸­æ·»åŠ `global_task_id`åˆ—å¹¶è®¾ç½®ä¸ºtask_idçš„åˆ«å

**ä¼˜ç‚¹**:
- ä»£ç æ— éœ€ä¿®æ”¹

**ç¼ºç‚¹**:
- éœ€è¦æ•°æ®åº“è¿ç§»
- å¢åŠ å†—ä½™å­—æ®µ
- å¤æ‚åº¦é«˜
- æ²¡æœ‰å®é™…ä»·å€¼

### æ¨èæ–¹æ¡ˆ

**é€‰æ‹©æ–¹æ¡ˆ1: ä¿®å¤æ•°æ®åº“æŸ¥è¯¢å­—æ®µå**

ç†ç”±:
- è¿™æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„bug,åº”è¯¥ç›´æ¥ä¿®å¤
- ä»£ç ä¸­å…¶ä»–åœ°æ–¹éƒ½ä½¿ç”¨`task_id`
- ç®€å•ã€å¿«é€Ÿã€æ— é£é™©

## æ ¹å› åˆ†æ

### é—®é¢˜æ¥æº

æŸ¥çœ‹`GlobalTask`ç±»çš„å®šä¹‰:

```python
@dataclass
class GlobalTask:
    task_id: str  # å®é™…å­—æ®µå
    # ...

    @property
    def global_task_id(self) -> str:  # å…¼å®¹æ€§å±æ€§
        return self.task_id
```

`global_task_id`åªæ˜¯ä¸€ä¸ªå±æ€§(property),ç”¨äºå‘åå…¼å®¹æ—§API,ä½†å®é™…å­—æ®µåå’Œæ•°æ®åº“åˆ—åéƒ½æ˜¯`task_id`ã€‚

### ä¸ºä»€ä¹ˆæ²¡æœ‰è¢«å‘ç°

1. **é™é»˜å¤±è´¥**: Supabaseçš„`.update().eq()`åœ¨åŒ¹é…ä¸åˆ°è®°å½•æ—¶ä¸æŠ¥é”™
2. **å†…å­˜æ›´æ–°æˆåŠŸ**: ä»£ç å…ˆæ›´æ–°äº†å†…å­˜ä¸­çš„å¯¹è±¡,æ‰€ä»¥å½“å‰ä¼šè¯çœ‹èµ·æ¥æ­£å¸¸
3. **ç¼ºå°‘æ—¥å¿—éªŒè¯**: æ›´æ–°å¤±è´¥çš„æ—¥å¿—è¢«å¿½ç•¥
4. **æµ‹è¯•è¦†ç›–ä¸è¶³**: æ²¡æœ‰éªŒè¯æ•°æ®åº“æŒä¹…åŒ–çš„æµ‹è¯•

## æŠ€æœ¯ç»†èŠ‚

### å½“å‰(é”™è¯¯çš„)ä»£ç æµç¨‹

```python
def update_task(self, global_task_id: str, **kwargs) -> bool:
    # 1. æ›´æ–°å†…å­˜ âœ… æˆåŠŸ
    task = self.tasks[global_task_id]
    for key, value in kwargs.items():
        setattr(task, key, value)

    # 2. æ›´æ–°æ•°æ®åº“ âŒ å¤±è´¥(WHEREæ¡ä»¶åŒ¹é…ä¸åˆ°)
    result = self.supabase.table('tasks')\
        .update(update_data)\
        .eq('global_task_id', global_task_id)\  # é”™è¯¯:å­—æ®µä¸å­˜åœ¨
        .execute()

    # 3. result.dataä¸ºç©º,ä½†ä¸å½±å“è¿”å›True
    return True if result.data else False
```

### ä¿®å¤åçš„æµç¨‹

```python
def update_task(self, task_id: str, **kwargs) -> bool:
    # 1. æ›´æ–°å†…å­˜ âœ… æˆåŠŸ
    task = self.tasks[task_id]
    for key, value in kwargs.items():
        setattr(task, key, value)

    # 2. æ›´æ–°æ•°æ®åº“ âœ… æˆåŠŸ
    result = self.supabase.table('tasks')\
        .update(update_data)\
        .eq('task_id', task_id)\  # æ­£ç¡®:ä½¿ç”¨å®é™…å­—æ®µå
        .execute()

    # 3. result.dataæœ‰æ•°æ®,è¿”å›True
    return True if result.data else False
```

## å½±å“è¯„ä¼°

### æ•°æ®ä¸€è‡´æ€§
- ğŸŸ¢ **ä¿®å¤å**: å†…å­˜å’Œæ•°æ®åº“çŠ¶æ€åŒæ­¥
- ğŸŸ¢ å†å²ä»»åŠ¡çŠ¶æ€å¯ä»¥æ­£ç¡®æŸ¥è¯¢
- ğŸŸ¢ åº”ç”¨é‡å¯åçŠ¶æ€ä¿æŒ

### å‘åå…¼å®¹æ€§
- âœ… **å®Œå…¨å…¼å®¹**: `task_id`æ˜¯æ ‡å‡†å­—æ®µå,æ‰€æœ‰ä»£ç éƒ½åœ¨ä½¿ç”¨
- âœ… ä¸å½±å“APIæ¥å£
- âœ… ä¸éœ€è¦å‰ç«¯ä¿®æ”¹

### æ€§èƒ½å½±å“
- ğŸŸ¢ **æ€§èƒ½æå‡**: å‡å°‘ä¸å¿…è¦çš„å†…å­˜-æ•°æ®åº“ä¸ä¸€è‡´
- ğŸŸ¢ æ•°æ®åº“æŸ¥è¯¢æ›´é«˜æ•ˆ(ä½¿ç”¨ç´¢å¼•å­—æ®µ)

### ç”¨æˆ·ä½“éªŒå½±å“
- ğŸŸ¢ **æ˜¾è‘—æ”¹å–„**: ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ­£ç¡®çš„ä»»åŠ¡å†å²
- ğŸŸ¢ å¯ä»¥åŒºåˆ†æ­£åœ¨è¿è¡Œã€å·²å®Œæˆã€å¤±è´¥çš„ä»»åŠ¡
- ğŸŸ¢ æ•°æ®æŒä¹…åŒ–,åˆ·æ–°é¡µé¢åçŠ¶æ€ä¿æŒ

## éªŒè¯æ–¹æ³•

### å•å…ƒæµ‹è¯•
```python
def test_task_status_update():
    manager = SupabaseTaskManager()

    # åˆ›å»ºä»»åŠ¡
    task = manager.create_task(...)
    assert task.status == 'running'

    # æ›´æ–°çŠ¶æ€
    success = manager.update_task_status(task.task_id, 'completed')
    assert success == True

    # éªŒè¯å†…å­˜
    updated_task = manager.get_task(task.task_id)
    assert updated_task.status == 'completed'

    # éªŒè¯æ•°æ®åº“
    db_result = manager.supabase.table('tasks')\
        .select('status')\
        .eq('task_id', task.task_id)\
        .execute()
    assert db_result.data[0]['status'] == 'completed'
```

### é›†æˆæµ‹è¯•
1. å¯åŠ¨åº”ç”¨
2. æ‰§è¡Œä¸€ä¸ªä»»åŠ¡å¹¶ç­‰å¾…å®Œæˆ
3. åˆ·æ–°æµè§ˆå™¨é¡µé¢
4. éªŒè¯ä»»åŠ¡çŠ¶æ€ä»ç„¶æ˜¯"completed"

### æ•°æ®åº“éªŒè¯
```sql
-- æ£€æŸ¥å®é™…å­—æ®µå
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'tasks';

-- åº”è¯¥çœ‹åˆ° task_id, è€Œä¸æ˜¯ global_task_id
```

## å®æ–½æ—¶é—´çº¿

### æ ¸å¿ƒä¿®å¤ (ç´§æ€¥)
- **è€—æ—¶**: 15åˆ†é’Ÿ
- **ä»»åŠ¡**:
  - ä¿®æ”¹`update_task()`æ–¹æ³•ä¸­çš„å­—æ®µå
  - éªŒè¯å…¶ä»–è°ƒç”¨ç‚¹ä½¿ç”¨æ­£ç¡®å­—æ®µå
  - æµ‹è¯•çŠ¶æ€æ›´æ–°

### æ•°æ®ä¿®å¤ (å¯é€‰)
- **è€—æ—¶**: 30åˆ†é’Ÿ
- **ä»»åŠ¡**:
  - æ£€æŸ¥æ•°æ®åº“ä¸­æ‰€æœ‰"running"çŠ¶æ€çš„ä»»åŠ¡
  - è¯†åˆ«å“ªäº›å®é™…ä¸Šå·²å®Œæˆ
  - æ‰‹åŠ¨æ›´æ–°å†å²ä»»åŠ¡çŠ¶æ€(æˆ–æ ‡è®°ä¸ºunknown)

## é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-----|------|---------|
| ä¿®æ”¹å­—æ®µåå¯¼è‡´å…¶ä»–ä»£ç å¤±è´¥ | æä½ | ä½ | å…¨å±€æœç´¢ç¡®è®¤æ²¡æœ‰å…¶ä»–ä½¿ç”¨global_task_idçš„åœ°æ–¹ |
| æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¸‹é™ | æ—  | æ—  | task_idæ˜¯ä¸»é”®,æœ‰ç´¢å¼• |
| æ—§æ•°æ®æ— æ³•ä¿®å¤ | ä¸­ | ä½ | æä¾›æ•°æ®ä¿®å¤è„šæœ¬ |

## éªŒæ”¶æ ‡å‡†

- âœ… ä»»åŠ¡å®Œæˆå,æ•°æ®åº“ä¸­çš„statuså­—æ®µæ­£ç¡®æ›´æ–°
- âœ… åˆ·æ–°é¡µé¢å,ä»»åŠ¡çŠ¶æ€ä¿æŒä¸å˜
- âœ… å†å²ä»»åŠ¡åˆ—è¡¨æ­£ç¡®æ˜¾ç¤ºcompleted/error/stoppedçŠ¶æ€
- âœ… åº”ç”¨é‡å¯å,ä»»åŠ¡çŠ¶æ€ä»ç„¶æ­£ç¡®
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

## åç»­å·¥ä½œ

1. **æ•°æ®ä¿®å¤è„šæœ¬**: ä¿®å¤å†å²æ•°æ®ä¸­çš„runningçŠ¶æ€
2. **ç›‘æ§å‘Šè­¦**: æ·»åŠ æ•°æ®åº“æ›´æ–°å¤±è´¥çš„å‘Šè­¦
3. **æµ‹è¯•å¢å¼º**: æ·»åŠ æ•°æ®åº“æŒä¹…åŒ–çš„é›†æˆæµ‹è¯•
4. **æ—¥å¿—å¢å¼º**: æ›´è¯¦ç»†çš„æ›´æ–°å¤±è´¥æ—¥å¿—

## å‚è€ƒ

- Supabase Python Clientæ–‡æ¡£
- GlobalTaskæ•°æ®æ¨¡å‹å®šä¹‰
- ä»»åŠ¡çŠ¶æ€æœºè®¾è®¡æ–‡æ¡£
