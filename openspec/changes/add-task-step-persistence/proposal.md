# Change: 任务步骤持久化

## Why

当前Open-AutoGLM系统在任务执行过程中缺乏详细的步骤跟踪和持久化能力。现有的任务管理只保存基本的任务信息（开始时间、结束时间、状态等），但缺少以下关键能力：

1. **步骤执行详情缺失** - 无法查看每个步骤的具体执行内容、截图、AI思考过程
2. **调试困难** - 当任务失败时，难以定位具体是哪个步骤出现问题
3. **无法生成执行报告** - 用户无法获取完整的任务执行过程报告
4. **学习价值丢失** - 用户无法回顾和分析任务的完整执行过程
5. **性能分析困难** - 无法分析各个步骤的耗时和性能瓶颈

实现任务步骤持久化将显著提升系统的可观测性、可调试性和用户体验。

## What Changes

### 新增数据库表和字段

1. **task_steps表** - 存储每个执行步骤的详细信息
2. **修改现有tasks表** - 添加步骤统计信息字段
3. **step_screenshots表** - 存储步骤截图的详细信息和文件路径

### 核心功能变更

1. **步骤数据收集** - 在PhoneAgent执行过程中收集详细的步骤信息
2. **实时数据写入** - 任务执行时实时将步骤数据写入数据库
3. **步骤关联** - 建立任务与步骤之间的完整关联关系
4. **数据压缩优化** - 对截图数据进行压缩和优化存储

### 新增API接口

1. **步骤查询API** - 提供详细的步骤数据查询接口
2. **执行报告API** - 生成任务执行报告的API
3. **步骤截图API** - 提供步骤相关截图的访问接口

### Web界面增强

1. **执行报告页面** - 新增专门的执行报告查看页面
2. **步骤详情展示** - 在Web界面中展示详细的步骤信息
3. **截图回放功能** - 支持按步骤回放任务执行截图

## Impact

### Affected Specs
- **task-execution** - 任务执行流程的步骤跟踪和持久化
- **database-schema** - 数据库表结构扩展
- **reporting** - 执行报告生成和展示

### Affected Code
- `phone_agent/agent.py` - 添加步骤跟踪和持久化逻辑
- `web/supabase_manager.py` - 扩展数据库管理功能
- `web/app.py` - 添加新的API端点
- `web/templates/` - 新增执行报告页面模板
- `database/create_supabase_tables.py` - 创建新的数据库表

### Breaking Changes
- **数据模型变更** - 新增数据库表，不影响现有API兼容性
- **性能影响** - 每个步骤会增加数据库写入操作，需要优化批量写入

### Dependencies
- 依赖Supabase作为数据存储后端
- 需要考虑网络连接对实时写入的影响
- 需要设计降级策略以处理数据库不可用的情况

## Success Criteria

1. **完整性** - 所有任务步骤都能完整记录和存储
2. **性能** - 步骤持久化不影响任务执行性能超过10%
3. **可靠性** - 即使数据库不可用，任务仍能正常执行
4. **易用性** - 用户能轻松查看和理解任务执行报告
5. **可扩展性** - 支持大规模步骤数据的存储和查询